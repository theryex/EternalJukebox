<div id="manual-analysis" style="display: none;">
    <h2>ðŸŽ· Floppa Analyzer</h2>

    <div id="floppa-status">
        <p id="floppa-message">Preparing to analyze this track...</p>
        <div class='progress_outer' id="floppa-progress-container"
            style="background-color: #333; max-width: 400px; height: 24px; border-radius: 4px; overflow: hidden;">
            <div id='floppa-progress'
                style="background-color: #4CAF50; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <p id="floppa-log" style="color: #888; font-size: 0.9em;"></p>
    </div>

    <div id="floppa-error" style="display: none;">
        <p style="color: #f44336;">Analysis failed. You can try the manual upload below:</p>
    </div>

    <div id="manual-upload-section"
        style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #444;">
        <h3>Manual Upload (Fallback)</h3>
        <p>If automatic analysis fails, you can manually provide the analysis file:</p>

        <ol>
            <li>
                <strong>Open Spotify:</strong>
                <a href="https://open.spotify.com" target="_blank" class="btn btn-small btn-default">Open Spotify</a>
                <a id="current-song-link" target="_blank" class="btn btn-small btn-default" style="display: none;">Open
                    current song in Spotify</a>
            </li>
            <li>
                <strong>Use the bookmarklet:</strong>
                Drag this to your bookmarks bar:
                <a href="javascript:(() => { {% include manual-analysis-script.js %} })();"
                    class="btn btn-small btn-default">Spotify Analysis Downloader</a>
            </li>
            <li>
                <strong>Upload the file:</strong>
                <form id="analysis-upload-form">
                    <input id="analysis-upload" type="file" name="song_upload" accept=".json">
                </form>
            </li>
        </ol>
    </div>

    <script>
        // Analyzer URL - uses local docker service if on same host, otherwise external
        // The analyzer runs on port 6874 in the docker-compose stack
        var floppaAnalyzerUrl = (function () {
            // If we're running locally (docker-compose), use the local analyzer
            // Otherwise fall back to the external URL
            var hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:6874';
            }
            // For production, use the same hostname but different port
            // This works when both services are exposed on the same server
            return window.location.protocol + '//' + hostname + ':6874';
        })();

        var currentTaskId = null;
        var pollInterval = null;

        function getSpotifyIdFromUrl() {
            var params = {};
            var q = document.URL.split('?')[1];
            if (q !== undefined) {
                q = q.split('&');
                for (var i = 0; i < q.length; i++) {
                    var pv = q[i].split('=');
                    if (pv.length === 2) {
                        params[pv[0]] = pv[1];
                    }
                }
            }
            return params['id'] || null;
        }

        function updateFloppaStatus(message, progress, log) {
            if (message) {
                $('#floppa-message').text(message);
            }
            if (progress !== undefined && progress !== null) {
                $('#floppa-progress').css('width', progress + '%');
            }
            if (log) {
                $('#floppa-log').text(log);
            }
        }

        function startFloppaAnalysis() {
            var trackId = getSpotifyIdFromUrl();
            if (!trackId) {
                showFloppaError('No track ID found in URL');
                return;
            }

            var spotifyUrl = 'https://open.spotify.com/track/' + trackId;

            updateFloppaStatus('Sending track to Floppa Analyzer...', 5, 'Connecting to analysis server...');

            $.ajax({
                url: floppaAnalyzerUrl + '/analyze/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ url: spotifyUrl }),
                success: function (response) {
                    if (response.task_id) {
                        currentTaskId = response.task_id;
                        updateFloppaStatus('Analysis started!', 10, response.meta ? 'Processing: ' + response.meta.title : 'Processing...');
                        startPolling();
                    } else {
                        showFloppaError('Invalid response from analyzer');
                    }
                },
                error: function (xhr, status, error) {
                    showFloppaError('Failed to start analysis: ' + error);
                }
            });
        }

        function startPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }

            pollInterval = setInterval(function () {
                if (!currentTaskId) return;

                $.ajax({
                    url: floppaAnalyzerUrl + '/analyze/status/' + currentTaskId,
                    type: 'GET',
                    success: function (response) {
                        updateFloppaStatus(null, response.progress, response.log);

                        if (response.status === 'completed') {
                            clearInterval(pollInterval);
                            updateFloppaStatus('Analysis complete! Reloading...', 100, 'Success!');
                            setTimeout(function () {
                                window.location.reload(true);
                            }, 1500);
                        } else if (response.status === 'error') {
                            clearInterval(pollInterval);
                            showFloppaError(response.log || 'Analysis failed');
                        }
                    },
                    error: function (xhr, status, error) {
                        // Don't stop polling on network errors, just log
                        console.log('Polling error:', error);
                    }
                });
            }, 2000);
        }

        function showFloppaError(message) {
            $('#floppa-message').text('Analysis failed');
            $('#floppa-log').text(message);
            $('#floppa-progress').css('background-color', '#f44336');
            $('#floppa-error').show();
            $('#manual-upload-section').show();
        }

        // Initialize when manual-analysis div is shown
        $(document).ready(function () {
            var observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        var target = $(mutation.target);
                        if (target.attr('id') === 'manual-analysis' && target.is(':visible')) {
                            startFloppaAnalysis();
                            observer.disconnect();
                        }
                    }
                });
            });

            observer.observe(document.getElementById('manual-analysis'), {
                attributes: true,
                attributeFilter: ['style']
            });

            // Setup current song link
            var trackId = getSpotifyIdFromUrl();
            if (trackId) {
                $('#current-song-link').attr('href', 'https://open.spotify.com/track/' + trackId).show();
            }
        });

        // Manual upload handler
        $("#analysis-upload").change(function () {
            var trackId = getSpotifyIdFromUrl();
            if (!trackId) {
                $("#floppa-log").text("No track ID found in URL");
                return;
            }

            var fileName = $(this)[0].files[0].name.split('.')[0];
            if (fileName !== trackId) {
                $("#floppa-log").text("Wrong file. Expected: " + trackId + ".json");
                return;
            }

            $.ajax({
                url: "/api/analysis/upload/" + trackId,
                type: "POST",
                data: new FormData($('#analysis-upload-form')[0]),
                processData: false,
                contentType: false,
                headers: {
                    "X-XSRF-TOKEN": document.cookie.substring(document.cookie.indexOf("XSRF-TOKEN")).split(";")[0].split("=").slice(1).join("=")
                },
                success: function () {
                    window.location.reload(true);
                },
                error: function (xhr, textStatus, error) {
                    if (xhr.responseJSON && typeof xhr.responseJSON.error === "string") {
                        error = xhr.responseJSON.error;
                    }
                    $("#floppa-log").text("Upload failed: " + error);
                }
            });
        });
    </script>
</div>